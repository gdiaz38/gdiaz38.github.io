<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Analytics Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #334155; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; margin-bottom: 40px; }
    .header h1 { font-size: 2.5rem; color: #1e293b; margin-bottom: 8px; font-weight: 700; }
    .header p { color: #64748b; font-size: 1.1rem; }
    .upload-section { background: white; border-radius: 12px; padding: 30px; margin-bottom: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
    .upload-area { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 40px; transition: all 0.3s ease; cursor: pointer; }
    .upload-area:hover { border-color: #3b82f6; background: #f8fafc; }
    .upload-area.dragover { border-color: #3b82f6; background: #eff6ff; }
    .file-input { display: none; }
    .upload-icon { font-size: 3rem; margin-bottom: 16px; color: #64748b; }
    .upload-text { font-size: 1.1rem; margin-bottom: 8px; color: #1e293b; }
    .upload-subtext { color: #64748b; font-size: 0.9rem; }
    .demo-button { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-top: 16px; font-weight: 500; transition: background 0.3s ease; }
    .demo-button:hover { background: #2563eb; }
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .controls { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
    select, button.reset-button { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; font-size: 0.9rem; color: #374151; cursor: pointer; }
    button.reset-button { background: #e2e8f0; font-weight: 500; }
    button.reset-button:hover { background: #cbd5e1; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .metric-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
    .metric-card:hover { transform: translateY(-2px); }
    .metric-label { color: #64748b; font-size: 0.9rem; font-weight: 500; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
    .metric-value { font-size: 2rem; font-weight: 700; color: #1e293b; margin-bottom: 4px; }
    .metric-change { font-size: 0.9rem; font-weight: 500; }
    .metric-change.positive { color: #059669; }
    .metric-change.negative { color: #dc2626; }
    .metric-change.neutral { color: #6b7280; }
    .charts-section { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
    .chart-container { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .chart-title { font-size: 1.2rem; font-weight: 600; color: #1e293b; margin-bottom: 20px; }
    .chart-canvas { position: relative; height: 300px; }
    .data-table-section { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .table-header { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; }
    .table-title { font-size: 1.2rem; font-weight: 600; color: #1e293b; }
    .data-table { overflow-x: auto; max-height: 400px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #f1f5f9; }
    th { background: #f8fafc; font-weight: 600; color: #475569; font-size: 0.9rem; position: sticky; top: 0; }
    tr:hover { background: #f8fafc; }
    .insights-section { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .insights-title { font-size: 1.2rem; font-weight: 600; color: #1e293b; margin-bottom: 20px; }
    .insight-item { padding: 16px 0; border-bottom: 1px solid #f1f5f9; }
    .insight-item:last-child { border-bottom: none; }
    .insight-text { color: #475569; }
    @media (max-width: 768px) { .charts-section { grid-template-columns: 1fr; } .metrics-grid { grid-template-columns: 1fr; } .header h1 { font-size: 2rem; } .container { padding: 16px; } }
    .loading { display: none; text-align: center; padding: 40px; color: #64748b; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Sales Analytics Dashboard</h1>
      <p>Upload your sales data CSV file or load the Superstore sample</p>
    </div>

    <div class="upload-section" id="uploadSection">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">ðŸ“Š</div>
        <div class="upload-text">Drop your CSV file here or click to browse</div>
        <div class="upload-subtext">Supports Superstore, sales transaction data, and similar CSV formats</div>
        <input type="file" class="file-input" id="fileInput" accept=".csv" />
      </div>
      <button class="demo-button" onclick="loadSuperstoreCSV()">Load Superstore Data</button>
    </div>

    <div class="loading" id="loading"><p>Processing your data...</p></div>

    <div class="dashboard" id="dashboard">
      <div class="controls">
        <select id="categoryFilter"><option value="all">All Categories</option></select>
        <select id="regionFilter"><option value="all">All Regions</option></select>
        <select id="timeFilter"><option value="all">All Time</option></select>
        <button class="reset-button" onclick="resetFilters()">Reset Filters</button>
      </div>

      <div class="metrics-grid" id="metricsGrid"></div>

      <div class="charts-section">
        <div class="chart-container">
          <h3 class="chart-title">Sales Trend Over Time</h3>
          <div class="chart-canvas"><canvas id="salesTrendChart"></canvas></div>
        </div>
        <div class="chart-container">
          <h3 class="chart-title">Top Categories</h3>
          <div class="chart-canvas"><canvas id="categoryChart"></canvas></div>
        </div>
      </div>

      <div class="data-table-section">
        <div class="table-header"><h3 class="table-title">Sales Data</h3></div>
        <div class="data-table">
          <table id="dataTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
        </div>
      </div>

      <div class="insights-section">
        <h3 class="insights-title">Key Insights</h3>
        <div id="insightsList"></div>
      </div>
    </div>
  </div>

  <script>
    let originalData = [];
    let salesData = [];
    let charts = {};

    // --- Robust date parsing (handles m/d/yy, m/d/yyyy, yyyy-mm-dd, with/without time, Excel serials) ---
    function parseDate(value) {
      if (!value && value !== 0) return null;
      if (value instanceof Date && !isNaN(value)) return value;
      if (typeof value === 'number') {
        // Excel serial date -> JS Date (Excel epoch: 1899-12-30)
        const ms = Math.round((value - 25569) * 86400 * 1000);
        const d = new Date(ms);
        return isNaN(d) ? null : d;
      }
      let s = String(value).trim();
      if (!s) return null;
      // remove time part if present
      s = s.replace(/[T ]\d{1,2}:\d{2}(:\d{2})?.*$/, '');

      // ISO-like yyyy-mm-dd or yyyy/mm/dd
      let m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
      if (m) {
        const y = +m[1], mo = +m[2], d = +m[3];
        const dt = new Date(y, mo - 1, d);
        return isNaN(dt) ? null : dt;
      }

      // Normalize separators
      const parts = s.split(/[\/\-]/);
      if (parts.length >= 3) {
        let [a, b, c] = parts;
        // fix 2-digit year -> 20xx for <50, else 19xx
        if (c.length <= 2) c = (Number(c) < 50 ? '20' : '19') + c.padStart(2, '0');
        const A = Number(a), B = Number(b), Y = Number(c);
        if (!isNaN(A) && !isNaN(B) && !isNaN(Y)) {
          // Heuristics: default to US month-first. Switch if obvious day-first.
          if (A > 12 && B <= 12) {
            // day-first (dd/mm/yyyy)
            const dt = new Date(Y, B - 1, A);
            return isNaN(dt) ? null : dt;
          }
          if (B > 12 && A <= 12) {
            // month-first but day exceeds 12 -> interpret as day-first fallback
            const dt = new Date(Y, A - 1, B);
            return isNaN(dt) ? null : dt;
          }
          // default month-first (mm/dd/yyyy)
          const dt = new Date(Y, A - 1, B);
          return isNaN(dt) ? null : dt;
        }
      }

      // Last resort: Date parser
      const dt = new Date(s);
      return isNaN(dt) ? null : dt;
    }

    // --- Calculate period-over-period changes ---
    function calculatePeriodChange(currentData, allData) {
      // Get date range of current filtered data
      const currentDates = currentData
        .map(row => parseDate(row['Order Date']))
        .filter(d => d)
        .sort((a, b) => a - b);
      
      if (currentDates.length === 0) return { sales: 0, profit: 0, orders: 0, avgOrder: 0 };
      
      const currentStart = currentDates[0];
      const currentEnd = currentDates[currentDates.length - 1];
      const periodDays = Math.ceil((currentEnd - currentStart) / (1000 * 60 * 60 * 24));
      
      // Calculate previous period (same duration, immediately before current period)
      const prevEnd = new Date(currentStart.getTime() - 1);
      const prevStart = new Date(prevEnd.getTime() - (periodDays * 24 * 60 * 60 * 1000));
      
      // Filter data for previous period
      const prevData = allData.filter(row => {
        const date = parseDate(row['Order Date']);
        return date && date >= prevStart && date <= prevEnd;
      });
      
      // Calculate current metrics
      const currentSales = currentData.reduce((s, r) => s + (parseFloat(r.Sales) || 0), 0);
      const currentProfit = currentData.reduce((s, r) => s + (parseFloat(r.Profit) || 0), 0);
      const currentOrders = currentData.length;
      const currentAvgOrder = currentOrders ? currentSales / currentOrders : 0;
      
      // Calculate previous metrics
      const prevSales = prevData.reduce((s, r) => s + (parseFloat(r.Sales) || 0), 0);
      const prevProfit = prevData.reduce((s, r) => s + (parseFloat(r.Profit) || 0), 0);
      const prevOrders = prevData.length;
      const prevAvgOrder = prevOrders ? prevSales / prevOrders : 0;
      
      // Calculate percentage changes
      const salesChange = prevSales ? ((currentSales - prevSales) / prevSales) * 100 : 0;
      const profitChange = prevProfit ? ((currentProfit - prevProfit) / prevProfit) * 100 : 0;
      const ordersChange = prevOrders ? ((currentOrders - prevOrders) / prevOrders) * 100 : 0;
      const avgOrderChange = prevAvgOrder ? ((currentAvgOrder - prevAvgOrder) / prevAvgOrder) * 100 : 0;
      
      return {
        sales: salesChange,
        profit: profitChange,
        orders: ordersChange,
        avgOrder: avgOrderChange
      };
    }

    // --- Format percentage change ---
    function formatChange(value) {
      if (Math.abs(value) < 0.1) {
        return { text: 'Â±0.0%', class: 'neutral' };
      }
      const sign = value >= 0 ? '+' : '';
      const className = value >= 0 ? 'positive' : 'negative';
      return { text: `${sign}${value.toFixed(1)}%`, class: className };
    }

    // --- Load Superstore CSV data (demo data) ---
    function loadSuperstoreCSV() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('uploadSection').style.display = 'none';
      
      // Generate sample data similar to Superstore format
      const sampleData = generateSampleData();
      processData(sampleData);
    }

    function generateSampleData() {
      const categories = ['Furniture', 'Office Supplies', 'Technology'];
      const subCategories = {
        'Furniture': ['Bookcases', 'Chairs', 'Tables'],
        'Office Supplies': ['Labels', 'Paper', 'Binders', 'Storage'],
        'Technology': ['Phones', 'Computers', 'Accessories']
      };
      const regions = ['South', 'West', 'East', 'Central'];
      const segments = ['Consumer', 'Corporate', 'Home Office'];
      const shipModes = ['Standard Class', 'Second Class', 'First Class', 'Same Day'];

      const data = [];
      const startDate = new Date('2019-01-01');
      const endDate = new Date('2021-12-31');

      for (let i = 1; i <= 1000; i++) {
        const category = categories[Math.floor(Math.random() * categories.length)];
        const subCategory = subCategories[category][Math.floor(Math.random() * subCategories[category].length)];
        const region = regions[Math.floor(Math.random() * regions.length)];
        const segment = segments[Math.floor(Math.random() * segments.length)];
        const shipMode = shipModes[Math.floor(Math.random() * shipModes.length)];
        
        // Random date within range
        const orderDate = new Date(startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime()));
        const shipDate = new Date(orderDate.getTime() + Math.random() * 7 * 24 * 60 * 60 * 1000);
        
        const quantity = Math.floor(Math.random() * 5) + 1;
        const unitPrice = Math.random() * 500 + 50;
        const discount = Math.random() * 0.5;
        const sales = quantity * unitPrice * (1 - discount);
        const profit = sales * (Math.random() * 0.3 - 0.05); // -5% to 25% margin

        data.push({
          'Row ID': i,
          'Order ID': `US-${orderDate.getFullYear()}-${String(Math.floor(Math.random() * 999999)).padStart(6, '0')}`,
          'Order Date': `${orderDate.getMonth() + 1}/${orderDate.getDate()}/${orderDate.getFullYear().toString().slice(-2)}`,
          'Ship Date': `${shipDate.getMonth() + 1}/${shipDate.getDate()}/${shipDate.getFullYear().toString().slice(-2)}`,
          'Ship Mode': shipMode,
          'Customer ID': `CG-${String(Math.floor(Math.random() * 99999)).padStart(5, '0')}`,
          'Customer Name': `Customer ${i}`,
          'Segment': segment,
          'Country/Region': 'United States',
          'City': 'Sample City',
          'State': 'Sample State',
          'Postal Code': String(Math.floor(Math.random() * 90000) + 10000),
          'Region': region,
          'Product ID': `${category.substring(0,3).toUpperCase()}-${subCategory.substring(0,2).toUpperCase()}-${String(Math.floor(Math.random() * 99999999)).padStart(8, '0')}`,
          'Category': category,
          'Sub-Category': subCategory,
          'Product Name': `Sample ${subCategory} Product ${i}`,
          'Sales': parseFloat(sales.toFixed(2)),
          'Quantity': quantity,
          'Discount': parseFloat(discount.toFixed(2)),
          'Profit': parseFloat(profit.toFixed(2))
        });
      }
      
      return data;
    }

    function processData(data) {
      // Normalize headers & keep only positive/valid sales rows
      originalData = data
        .map((row) => {
          const normalizedRow = {};
          Object.keys(row).forEach((key) => {
            const k = key ? key.trim() : key;
            normalizedRow[k] = row[key];
          });
          return normalizedRow;
        })
        .filter((row) => parseFloat(row.Sales) > 0);

      salesData = [...originalData];

      // Initialize UI
      updateDashboard();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
    }

    function updateDashboard() {
      updateFilters();
      updateMetrics();
      updateCharts();
      updateTable();
      updateInsights();
    }

    function updateMetrics() {
      const totalSales = salesData.reduce((s, r) => s + (parseFloat(r.Sales) || 0), 0);
      const totalProfit = salesData.reduce((s, r) => s + (parseFloat(r.Profit) || 0), 0);
      const avgOrderValue = salesData.length ? totalSales / salesData.length : 0;
      
      // Calculate period-over-period changes
      const changes = calculatePeriodChange(salesData, originalData);
      const salesChange = formatChange(changes.sales);
      const profitChange = formatChange(changes.profit);
      const ordersChange = formatChange(changes.orders);
      const avgOrderChange = formatChange(changes.avgOrder);

      const metricsGrid = document.getElementById('metricsGrid');
      metricsGrid.innerHTML = `
        <div class="metric-card">
          <div class="metric-label">Total Sales</div>
          <div class="metric-value">$${totalSales.toLocaleString('en-US', { maximumFractionDigits: 0 })}</div>
          <div class="metric-change ${salesChange.class}">${salesChange.text} vs last period</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Total Profit</div>
          <div class="metric-value">$${totalProfit.toLocaleString('en-US', { maximumFractionDigits: 0 })}</div>
          <div class="metric-change ${profitChange.class}">${profitChange.text} vs last period</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Total Orders</div>
          <div class="metric-value">${salesData.length.toLocaleString()}</div>
          <div class="metric-change ${ordersChange.class}">${ordersChange.text} vs last period</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Avg Order Value</div>
          <div class="metric-value">$${avgOrderValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</div>
          <div class="metric-change ${avgOrderChange.class}">${avgOrderChange.text} vs last period</div>
        </div>`;
    }

    function updateCharts() {
      // --- Sales trend (monthly) ---
      const monthly = new Map(); // key: 'YYYY-MM' -> sum sales
      for (const row of salesData) {
        const d = parseDate(row['Order Date']);
        if (!d) continue;
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        monthly.set(key, (monthly.get(key) || 0) + (parseFloat(row.Sales) || 0));
      }
      const months = Array.from(monthly.keys()).sort();
      const salesValues = months.map((m) => monthly.get(m));

      if (charts.salesTrend) charts.salesTrend.destroy();
      const ctx1 = document.getElementById('salesTrendChart').getContext('2d');
      charts.salesTrend = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: months.map((m) => {
            const [y, mm] = m.split('-');
            return new Date(Number(y), Number(mm) - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          }),
          datasets: [{
            label: 'Sales',
            data: salesValues,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59,130,246,0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: (v) => '$' + (v / 1000).toFixed(0) + 'K' }
            }
          }
        }
      });

      // --- Category doughnut ---
      const byCategory = new Map();
      for (const row of salesData) {
        const cat = row.Category || 'Unknown';
        byCategory.set(cat, (byCategory.get(cat) || 0) + (parseFloat(row.Sales) || 0));
      }
      if (charts.category) charts.category.destroy();
      const ctx2 = document.getElementById('categoryChart').getContext('2d');
      charts.category = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: Array.from(byCategory.keys()),
          datasets: [{
            data: Array.from(byCategory.values()),
            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function updateTable() {
      const display = salesData.slice(0, 50);
      const columns = Object.keys(display[0] || {});
      const thead = document.getElementById('tableHead');
      thead.innerHTML = `<tr>${columns.map((c) => `<th>${c}</th>`).join('')}</tr>`;
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = display
        .map((row) => `<tr>${columns
          .map((c) => {
            let v = row[c];
            if (typeof v === 'number' && (c.includes('Sales') || c.includes('Profit'))) {
              v = '$' + v.toLocaleString('en-US', { maximumFractionDigits: 0 });
            }
            return `<td>${v ?? ''}</td>`;
          })
          .join('')}</tr>`)
        .join('');
    }

    // --- Filters ---
    function populateSelect(select, values, allLabel) {
      const prev = select.value;
      select.innerHTML = `<option value="all">${allLabel}</option>` + values.map((v) => `<option value="${v}">${v}</option>`).join('');
      if (values.includes(prev)) {
        select.value = prev;
      } else {
        select.value = 'all';
      }
    }

    function updateFilters() {
      // Categories & Regions from full dataset so options don't collapse
      const categories = Array.from(new Set(originalData.map((r) => r.Category || 'Unknown'))).sort();
      const regions = Array.from(new Set(originalData.map((r) => r.Region || 'Unknown'))).sort();
      const years = Array.from(new Set(originalData
        .map((r) => parseDate(r['Order Date']))
        .filter((d) => d)
        .map((d) => d.getFullYear())))
        .sort((a, b) => b - a);

      populateSelect(document.getElementById('categoryFilter'), categories, 'All Categories');
      populateSelect(document.getElementById('regionFilter'), regions, 'All Regions');
      populateSelect(document.getElementById('timeFilter'), years.map(String), 'All Time');
    }

    function applyFilters() {
      const category = document.getElementById('categoryFilter').value;
      const region = document.getElementById('regionFilter').value;
      const year = document.getElementById('timeFilter').value;

      salesData = originalData.filter((row) => {
        let keep = true;
        if (category !== 'all') keep = keep && row.Category === category;
        if (region !== 'all') keep = keep && row.Region === region;
        if (year !== 'all') {
          const d = parseDate(row['Order Date']);
          keep = keep && d && String(d.getFullYear()) === year;
        }
        return keep;
      });

      updateMetrics();
      updateCharts();
      updateTable();
      updateInsights();
    }

    function resetFilters() {
      document.getElementById('categoryFilter').value = 'all';
      document.getElementById('regionFilter').value = 'all';
      document.getElementById('timeFilter').value = 'all';
      salesData = [...originalData];
      updateDashboard();
    }

    function updateInsights() {
      const totalSales = salesData.reduce((s, r) => s + (parseFloat(r.Sales) || 0), 0);
      const byCat = {};
      const byReg = {};
      for (const r of salesData) {
        const c = r.Category || 'Unknown';
        const g = r.Region || 'Unknown';
        byCat[c] = (byCat[c] || 0) + (parseFloat(r.Sales) || 0);
        byReg[g] = (byReg[g] || 0) + (parseFloat(r.Sales) || 0);
      }
      const topCat = Object.entries(byCat).sort((a, b) => b[1] - a[1])[0];
      const topReg = Object.entries(byReg).sort((a, b) => b[1] - a[1])[0];

      const insights = document.getElementById('insightsList');
      insights.innerHTML = `
        <div class="insight-item"><div class="insight-text">Total sales across current filters: <strong>$${totalSales.toLocaleString('en-US', { maximumFractionDigits: 0 })}</strong></div></div>
        ${topCat ? `<div class="insight-item"><div class="insight-text">Top category: <strong>${topCat[0]}</strong> â€” $${topCat[1].toLocaleString('en-US', { maximumFractionDigits: 0 })}</div></div>` : ''}
        ${topReg ? `<div class="insight-item"><div class="insight-text">Best region: <strong>${topReg[0]}</strong> â€” ${topReg[1].toLocaleString('en-US', { maximumFractionDigits: 0 })}</div></div>` : ''}
        <div class="insight-item"><div class="insight-text">Coverage: ${salesData.length} transactions across ${Object.keys(byCat).length} categories and ${Object.keys(byReg).length} regions.</div></div>`;
    }

    // --- Upload handlers ---
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (file) parseCSV(file);
    });
    fileInput.addEventListener('change', (e) => { const file = e.target.files && e.target.files[0]; if (file) parseCSV(file); });

    function parseCSV(file) {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('uploadSection').style.display = 'none';
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: true,
        complete: (results) => processData(results.data)
      });
    }

    // Filter change listeners
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('regionFilter').addEventListener('change', applyFilters);
    document.getElementById('timeFilter').addEventListener('change', applyFilters);
  </script>
</body>
</html>
